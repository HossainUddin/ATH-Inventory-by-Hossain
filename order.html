<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ATH Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-gray-800">
    <div class="max-w-6xl mx-auto p-6">
      <header class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <h1 class="text-2xl font-bold">ATH Order</h1>
          <button
            class="bg-lime-500 hover:bg-lime-900 px-6 py-2 rounded-2xl text-white font-bold"
          >
            <a href="index.html">Inventory</a>
          </button>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="openAdminBtn"
            class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700"
          >
            Admin Panel
          </button>
          <button
            id="clearStorageBtn"
            class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
          >
            Clear All Storage
          </button>
        </div>
      </header>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left: Order Form -->
        <section class="bg-white p-5 rounded shadow">
          <h2 class="text-lg font-semibold mb-3">Create Order</h2>
          <form id="orderForm" class="space-y-4" onsubmit="return false;">
            <div>
              <label class="block text-sm font-medium">Name</label>
              <input
                id="custName"
                required
                class="mt-1 block w-full border rounded p-2"
                placeholder="e.g. Hossain Uddin"
              />
            </div>

            <div>
              <label class="block text-sm font-medium">Mobile Number</label>
              <input
                id="custPhone"
                required
                pattern="\d*"
                inputmode="numeric"
                maxlength="14"
                class="mt-1 block w-full border rounded p-2"
                placeholder="e.g. 013xxxxxxxx"
              />
              <p id="phoneHint" class="text-xs text-red-500 mt-1 hidden">
                Number must be at least 11 digits.
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium">Address</label>
              <textarea
                id="custAddress"
                rows="3"
                required
                class="mt-1 block w-full border rounded p-2"
                placeholder="Big address..."
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium">Note (optional)</label>
              <textarea
                id="custNote"
                rows="2"
                class="mt-1 block w-full border rounded p-2"
                placeholder="Leave a note... e.g. Please call before delivery"
              ></textarea>
            </div>

            <hr />

            <div>
              <label class="block text-sm font-medium">Search Product</label>
              <input
                id="productSearch"
                class="mt-1 block w-full border rounded p-2 bg-slate-200"
                placeholder="Type product name... (searchable)"
              />
              <div
                id="searchResults"
                class="mt-1 border rounded bg-slate-300 max-h-40 overflow-auto hidden"
              ></div>
            </div>

            <div class="flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-sm font-medium"
                  >Selected Product</label
                >
                <input
                  id="selectedProductName"
                  readonly
                  class="mt-1 block w-full border rounded p-2 bg-slate-50"
                  placeholder="Select product from search"
                />
              </div>
              <div class="w-28">
                <label class="block text-sm font-medium">Price</label>
                <input
                  id="selectedProductPrice"
                  readonly
                  class="mt-1 block w-full border rounded p-2 bg-slate-50 text-right"
                />
              </div>
              <div class="w-28">
                <label class="block text-sm font-medium">Qty</label>
                <input
                  id="selectedProductQty"
                  type="number"
                  min="1"
                  value="1"
                  class="mt-1 block w-full border rounded p-2 text-right"
                />
              </div>
              <button
                id="addItemBtn"
                type="button"
                class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
              >
                Add
              </button>
            </div>

            <hr />

            <div>
              <h3 class="font-medium">Order Items</h3>
              <div id="itemsList" class="mt-2 space-y-2"></div>
              <p id="noItems" class="text-sm text-gray-500 mt-2">
                No items yet. Add products above.
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium">Delivery</label>
              <div class="flex gap-3 mt-1">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="delivery" value="inside" checked />
                  Inside (BDT 60)
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="delivery" value="outside" /> Outside
                  (BDT 120)
                </label>
              </div>
            </div>

            <div class="flex justify-between items-center">
              <div>
                <button
                  id="holdBtn"
                  type="button"
                  class="px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"
                >
                  Hold Order
                </button>
                <span id="holdInfo" class="text-sm text-gray-600 ml-3"></span>
              </div>

              <div class="text-right">
                <div class="text-sm">
                  Subtotal:
                  <span id="subtotalText" class="font-medium">0</span> BDT
                </div>
                <div class="text-sm">
                  Delivery:
                  <span id="deliveryText" class="font-medium">0</span> BDT
                </div>
                <div class="text-lg font-semibold">
                  Total: <span id="totalText">0</span> BDT
                </div>
              </div>
            </div>

            <div class="flex gap-2">
              <button
                id="copyBtn"
                type="button"
                class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              >
                Save & Copy Order
              </button>
              <button
                id="resetBtn"
                type="button"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
              >
                Reset
              </button>
            </div>
          </form>
        </section>

        <!-- Right: Product list + Preview -->
        <aside class="space-y-4">
          <section class="bg-white p-5 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">
              Products (visible to visitors)
            </h2>
            <div id="productCatalog" class="grid grid-cols-2 gap-2 max-h-[200px] overflow-y-scroll"></div>
          </section>

          <section class="bg-white p-5 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">Order Preview</h2>
            <pre
              id="orderPreview"
              class="whitespace-pre-wrap bg-slate-50 p-3 rounded min-h-[220px] border text-sm leading-relaxed"
            ></pre>
          </section>
        </aside>
      </div>
    </div>

    <!-- Admin Modal -->
    <div
      id="adminModal"
      class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4"
    >
      <div class="bg-white w-full max-w-4xl rounded shadow p-5 relative">
        <button
          id="closeAdminBtn"
          class="absolute top-2 right-2 px-2 py-1 bg-red-500 text-white rounded"
        >
          X
        </button>
        <h2 class="text-xl font-semibold mb-4">Admin Panel</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Product Management -->
          <div class="p-3 border rounded bg-slate-50">
            <h3 class="font-medium mb-2">📦 Product Management</h3>
            <div class="flex gap-2 mb-3">
              <button
                id="exportProductsBtn"
                class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              >
                Export Products
              </button>
              <label
                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer"
              >
                Import Products
                <input
                  type="file"
                  id="importProductsInput"
                  accept=".json"
                  class="hidden"
                />
              </label>
            </div>
            <div class="text-xs text-gray-600">
              Import expects an array of products:
              [{"id":"...","name":"...","price":123}, ...]. If id omitted one
              will be generated.
            </div>
          </div>

          <!-- Orders Export/Import -->
          <div class="p-3 border rounded bg-slate-50">
            <h3 class="font-medium mb-2">📥 Orders</h3>
            <div class="flex gap-2 mb-3">
              <button
                id="exportOrdersBtn"
                class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              >
                Export Orders
              </button>
              <label
                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer"
              >
                Import Orders
                <input
                  type="file"
                  id="importOrdersInput"
                  accept=".json"
                  class="hidden"
                />
              </label>
              <button
                id="clearOrdersBtn"
                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600"
              >
                Clear Orders
              </button>
            </div>
            <div class="text-xs text-gray-600">
              Export downloads all saved orders as JSON. Import will replace
              existing orders.
            </div>
          </div>
        </div>

        <h3 class="font-medium mb-2">📝 Orders List</h3>
        <div
          id="adminOrders"
          class="space-y-4 max-h-[50vh] overflow-auto"
        ></div>
      </div>
    </div>

    <script>
      /* ===== Utilities ===== */
      function uid() {
        return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
      }
      function formatBDT(n) {
        return Number(n).toLocaleString("en-BD");
      }

      /* ===== Persistence Keys ===== */
      const PRODUCTS_KEY = "easy_order_products_v1";
      const ORDERS_KEY = "easy_order_orders_v1";

      /* ===== Load / Save Products ===== */
      let products = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || "[]");
      if (!Array.isArray(products) || products.length === 0) {
        products = [
          { id: uid(), name: "Gadget A", price: 1000 }
        ];
        localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
      }
      function saveProducts() {
        localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
      }

      /* ===== Load / Save Orders ===== */
      function loadOrders() {
        try {
          return JSON.parse(localStorage.getItem(ORDERS_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }
      function saveOrders(orders) {
        localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
      }

      /* ===== DOM refs ===== */
      const productSearch = document.getElementById("productSearch");
      const searchResults = document.getElementById("searchResults");
      const selectedProductName = document.getElementById(
        "selectedProductName"
      );
      const selectedProductPrice = document.getElementById(
        "selectedProductPrice"
      );
      const selectedProductQty = document.getElementById("selectedProductQty");
      const addItemBtn = document.getElementById("addItemBtn");
      const itemsList = document.getElementById("itemsList");
      const noItems = document.getElementById("noItems");
      const subtotalText = document.getElementById("subtotalText");
      const deliveryText = document.getElementById("deliveryText");
      const totalText = document.getElementById("totalText");
      const orderPreview = document.getElementById("orderPreview");
      const custName = document.getElementById("custName");
      const custPhone = document.getElementById("custPhone");
      const phoneHint = document.getElementById("phoneHint");
      const custAddress = document.getElementById("custAddress");
      const custNote = document.getElementById("custNote");
      const copyBtn = document.getElementById("copyBtn");
      const resetBtn = document.getElementById("resetBtn");
      const holdBtn = document.getElementById("holdBtn");
      const holdInfo = document.getElementById("holdInfo");
      const openAdminBtn = document.getElementById("openAdminBtn");
      const adminModal = document.getElementById("adminModal");
      const closeAdminBtn = document.getElementById("closeAdminBtn");
      const adminOrders = document.getElementById("adminOrders");
      const exportProductsBtn = document.getElementById("exportProductsBtn");
      const importProductsInput = document.getElementById(
        "importProductsInput"
      );
      const exportOrdersBtn = document.getElementById("exportOrdersBtn");
      const importOrdersInput = document.getElementById("importOrdersInput");
      const clearOrdersBtn = document.getElementById("clearOrdersBtn");
      const clearStorageBtn = document.getElementById("clearStorageBtn");

      /* ===== App State ===== */
      let orderItems = []; // {id, productId, name, price, qty}
      let holdInfoState = null; // {date}

      /* ===== Render Catalog ===== */
      function renderCatalog() {
        const productCatalog = document.getElementById("productCatalog");
        productCatalog.innerHTML = "";
        if (products.length === 0) {
          productCatalog.innerHTML =
            '<div class="text-sm text-gray-500">No products</div>';
          return;
        }
        products.forEach((p) => {
          const card = document.createElement("div");
          card.className =
            "p-3 border rounded bg-slate-50 cursor-pointer hover:bg-slate-100";
          card.setAttribute("data-prod-id", p.id);
          card.innerHTML = `<div class="text-sm font-medium">${escapeHtml(
            p.name
          )}</div><div class="text-sm">BDT <span class="font-semibold">${formatBDT(
            p.price
          )}</span></div>`;
          card.addEventListener("click", () => selectProduct(p));
          productCatalog.appendChild(card);
        });
      }

      function selectProduct(p) {
        selectedProductName.value = p.name;
        selectedProductPrice.value = p.price;
        selectedProductQty.value = 1;
        selectedProductName.dataset.prodid = p.id;
      }

      renderCatalog();

      /* ===== Search ===== */
      productSearch.addEventListener("input", () => {
        const q = productSearch.value.trim().toLowerCase();
        if (!q) {
          searchResults.classList.add("hidden");
          return;
        }
        const matched = products.filter((p) =>
          p.name.toLowerCase().includes(q)
        );
        if (matched.length === 0) {
          searchResults.innerHTML =
            '<div class="p-2 text-sm text-gray-500">No match</div>';
        } else {
          searchResults.innerHTML = matched
            .map(
              (p) =>
                `<div class="p-2 cursor-pointer hover:bg-indigo-50" data-id="${
                  p.id
                }"><div class="text-sm font-medium">${escapeHtml(
                  p.name
                )}</div><div class="text-xs text-gray-500">BDT ${formatBDT(
                  p.price
                )}</div></div>`
            )
            .join("");
        }
        searchResults.classList.remove("hidden");
      });

      searchResults.addEventListener("click", (e) => {
        const el = e.target.closest("[data-id]");
        if (!el) return;
        const id = el.dataset.id;
        const p = products.find((x) => x.id === id);
        if (!p) return;
        selectProduct(p);
        searchResults.classList.add("hidden");
        productSearch.value = "";
      });

      document.addEventListener("click", (e) => {
        if (
          !productSearch.contains(e.target) &&
          !searchResults.contains(e.target)
        )
          searchResults.classList.add("hidden");
      });

      /* ===== Items management ===== */
      addItemBtn.addEventListener("click", () => {
        const prodId = selectedProductName.dataset.prodid;
        if (!prodId) {
          alert("Select a product first (search or click).");
          return;
        }
        const prod = products.find((p) => p.id === prodId);
        if (!prod) {
          alert("Product not found");
          return;
        }
        const qty = Math.max(1, Number(selectedProductQty.value) || 1);
        orderItems.push({
          id: uid(),
          productId: prod.id,
          name: prod.name,
          price: prod.price,
          qty,
        });
        selectedProductName.value = "";
        selectedProductPrice.value = "";
        delete selectedProductName.dataset.prodid;
        renderItems();
        recalcAndRender();
      });

      function renderItems() {
        itemsList.innerHTML = "";
        if (orderItems.length === 0) {
          noItems.classList.remove("hidden");
          return;
        }
        noItems.classList.add("hidden");
        orderItems.forEach((item) => {
          const row = document.createElement("div");
          row.className = "flex items-center gap-2 border rounded p-2";
          row.innerHTML = `
      <div class="flex-1">
        <div class="font-medium">${escapeHtml(item.name)}</div>
        <div class="text-xs text-gray-500">BDT ${formatBDT(
          item.price
        )} x <input data-item="${
            item.id
          }" class="inline-block w-14 text-right border rounded p-1 ml-2" value="${
            item.qty
          }" type="number" min="1"></div>
      </div>
      <div class="w-28 text-right">BDT <span class="item-sub" data-item="${
        item.id
      }">${formatBDT(item.price * item.qty)}</span></div>
      <div class="flex flex-col gap-1 ml-2">
        <button data-action="remove" data-id="${
          item.id
        }" class="px-2 py-1 text-sm border rounded">Remove</button>
      </div>
    `;
          itemsList.appendChild(row);
        });

        // qty change
        itemsList.querySelectorAll('input[type="number"]').forEach((inp) => {
          inp.addEventListener("change", () => {
            const id = inp.dataset.item;
            const val = Math.max(1, Number(inp.value) || 1);
            const it = orderItems.find((x) => x.id === id);
            if (it) {
              it.qty = val;
              renderItems();
              recalcAndRender();
            }
          });
        });
        // remove
        itemsList.querySelectorAll('[data-action="remove"]').forEach((btn) =>
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            orderItems = orderItems.filter((x) => x.id !== id);
            renderItems();
            recalcAndRender();
          })
        );
      }

      /* ===== Delivery & totals ===== */
      function getDeliveryCharge() {
        const val = document.querySelector(
          'input[name="delivery"]:checked'
        ).value;
        return val === "inside" ? 60 : 120;
      }
      document
        .querySelectorAll('input[name="delivery"]')
        .forEach((r) => r.addEventListener("change", recalcAndRender));

      function recalcAndRender() {
        const subtotal = orderItems.reduce((s, i) => s + i.price * i.qty, 0);
        const delivery = orderItems.length ? getDeliveryCharge() : 0;
        const total = subtotal + delivery;
        subtotalText.textContent = formatBDT(subtotal);
        deliveryText.textContent = formatBDT(delivery);
        totalText.textContent = formatBDT(total);
        renderPreview();
      }

      /* ===== Preview & Save Order ===== */
      function renderPreview() {
        const name = custName.value.trim() || "[Name]";
        const phone = custPhone.value.trim() || "[Mobile]";
        const addr = custAddress.value.trim() || "[Address]";
        const note = custNote.value.trim();
        const subtotal = orderItems.reduce((s, i) => s + i.price * i.qty, 0);
        const delivery = orderItems.length ? getDeliveryCharge() : 0;
        const total = subtotal + delivery;
        const itemsText = orderItems.length
          ? orderItems
              .map((it) => ` Product: ${it.name} – Qty: ${it.qty}`)
              .join("\n")
          : "No products added yet.";
        const holdText =
          holdInfoState && holdInfoState.date
            ? `\n\n⏳ Hold until: ${holdInfoState.date}`
            : "";
        const preview = `❤ Your order has been confirmed!\n\nCustomer Details:\n Name: ${name}\n Mobile: ${phone}\n Address: ${addr}\n${
          note ? " Note: " + note + "\n" : ""
        }\nOrder Details:\n${itemsText}\n\n Subtotal: ${subtotal}\n Delivery Charge: ${delivery}\n Total: ${total}\n\nThank you, Sir/Madam \nOur team will contact you soon regarding delivery.${holdText}`;
        orderPreview.textContent = preview;
      }

      copyBtn.addEventListener("click", async () => {
        const phoneVal = custPhone.value.replace(/\D/g, "");
        if (phoneVal.length < 11) {
          phoneHint.classList.remove("hidden");
          return;
        } else phoneHint.classList.add("hidden");
        if (orderItems.length === 0) {
          alert("Add at least one product");
          return;
        }
        renderPreview();
        const text = orderPreview.textContent;
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          console.warn("clipboard failed", e);
        }

        // Save order to storage
        const subtotal = orderItems.reduce((s, i) => s + i.price * i.qty, 0);
        const delivery = orderItems.length ? getDeliveryCharge() : 0;
        const total = subtotal + delivery;
        const orderData = {
          id: uid(),
          createdAt: new Date().toISOString(),
          name: custName.value.trim(),
          phone: custPhone.value.trim(),
          address: custAddress.value.trim(),
          note: custNote.value.trim(),
          items: orderItems.map((it) => ({
            name: it.name,
            price: it.price,
            qty: it.qty,
            productId: it.productId,
          })),
          subtotal,
          delivery,
          total,
          hold: holdInfoState,
        };
        const orders = loadOrders();
        orders.push(orderData);
        saveOrders(orders);
        copyBtn.textContent = "Saved & Copied!";
        setTimeout(() => (copyBtn.textContent = "Save & Copy Order"), 1500);
        renderAdminOrders();
      });

      /* ===== Reset ===== */
      resetBtn.addEventListener("click", () => {
        if (!confirm("Reset current order?")) return;
        orderItems = [];
        holdInfoState = null;
        custName.value = "";
        custPhone.value = "";
        custAddress.value = "";
        custNote.value = "";
        document.querySelector(
          'input[name="delivery"][value="inside"]'
        ).checked = true;
        holdInfo.textContent = "";
        renderItems();
        recalcAndRender();
      });

      /* ===== Hold ===== */
      holdBtn.addEventListener("click", () => {
        if (holdInfoState && holdInfoState.date) {
          alert("Order already on hold until " + holdInfoState.date);
          return;
        }
        const d = prompt("Enter release date for delivery (YYYY-MM-DD):");
        if (!d) return;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(d)) {
          alert("Invalid date format");
          return;
        }
        holdInfoState = { date: d };
        holdInfo.textContent = `Hold until: ${d}`;
        holdBtn.disabled = true;
        renderPreview();
      });

      /* ===== Admin Panel ===== */
      openAdminBtn.addEventListener("click", () => {
        adminModal.classList.remove("hidden");
        adminModal.classList.add("flex");
        renderAdminOrders();
      });
      closeAdminBtn.addEventListener("click", () => {
        adminModal.classList.add("hidden");
      });

      function renderAdminOrders() {
        const orders = loadOrders();
        adminOrders.innerHTML = "";
        if (orders.length === 0) {
          adminOrders.innerHTML = '<p class="text-gray-500">No orders yet.</p>';
          return;
        }
        orders
          .slice()
          .reverse()
          .forEach((o, idx) => {
            // show newest first
            const div = document.createElement("div");
            div.className = "border rounded p-3 bg-white shadow-sm";
            const itemsHtml = o.items
              .map(
                (it) =>
                  `<div class="text-sm">📦 <b>${escapeHtml(
                    it.name
                  )}</b> — Qty: ${it.qty} — BDT ${formatBDT(it.price)}</div>`
              )
              .join("");
            div.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">Order — ${new Date(
            o.createdAt
          ).toLocaleString()}</div>
          <div class="text-sm">👤 ${escapeHtml(o.name)} • 📱 ${escapeHtml(
              o.phone
            )}</div>
          <div class="text-sm">🏠 ${escapeHtml(o.address)}</div>
        </div>
        <div class="text-right">
          <button data-action="export-order" class="px-2 py-1 border rounded text-sm mr-2">Export</button>
          <button data-action="delete-order" class="px-2 py-1 border rounded text-sm text-red-600">Delete</button>
        </div>
      </div>
      ${
        o.note
          ? `<div class="mt-2 text-sm bg-yellow-50 border border-yellow-200 rounded p-2">📝 ${escapeHtml(
              o.note
            )}</div>`
          : ""
      }
      <div class="mt-2 border-t pt-2">${itemsHtml}</div>
      <div class="mt-2 text-sm">💵 Subtotal: ${formatBDT(
        o.subtotal
      )} • 🚚 ${formatBDT(o.delivery)} • 💰 ${formatBDT(o.total)}</div>
    `;
            // attach actions
            div
              .querySelector('[data-action="delete-order"]')
              .addEventListener("click", () => {
                if (!confirm("Delete this order?")) return;
                const all = loadOrders().filter((x) => x.id !== o.id);
                saveOrders(all);
                renderAdminOrders();
              });
            div
              .querySelector('[data-action="export-order"]')
              .addEventListener("click", () => {
                const blob = new Blob([JSON.stringify(o, null, 2)], {
                  type: "application/json",
                });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `order_${o.id}.json`;
                a.click();
              });
            adminOrders.appendChild(div);
          });
      }

      /* ===== Export / Import Products ===== */
      exportProductsBtn.addEventListener("click", () => {
        const dataStr = JSON.stringify(products, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "products.json";
        a.click();
      });

      importProductsInput.addEventListener("change", (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!Array.isArray(imported))
              throw new Error("Invalid format — expected array");
            // normalize entries: ensure id,name,price
            const normalized = imported.map((it) => ({
              id: it.id || uid(),
              name: String(it.name || "Unnamed"),
              price: Number(it.price || 0),
            }));
            products = normalized;
            saveProducts();
            renderCatalog();
            alert("Products imported successfully");
          } catch (err) {
            alert("Import failed: " + err.message);
          }
        };
        r.readAsText(f);
        e.target.value = "";
      });

      /* ===== Export / Import Orders ===== */
      exportOrdersBtn.addEventListener("click", () => {
        const orders = loadOrders();
        const blob = new Blob([JSON.stringify(orders, null, 2)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "orders.json";
        a.click();
      });

      importOrdersInput.addEventListener("change", (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!Array.isArray(imported))
              throw new Error("Invalid format — expected array");
            // basic validation: ensure id and createdAt
            const normalized = imported.map((it) => ({
              id: it.id || uid(),
              createdAt: it.createdAt || new Date().toISOString(),
              name: it.name || "",
              phone: it.phone || "",
              address: it.address || "",
              note: it.note || "",
              items: Array.isArray(it.items) ? it.items : [],
              subtotal: Number(it.subtotal || 0),
              delivery: Number(it.delivery || 0),
              total: Number(it.total || 0),
              hold: it.hold || null,
            }));
            saveOrders(normalized);
            renderAdminOrders();
            alert("Orders imported (replaced existing)");
          } catch (err) {
            alert("Import failed: " + err.message);
          }
        };
        r.readAsText(f);
        e.target.value = "";
      });

      clearOrdersBtn.addEventListener("click", () => {
        if (!confirm("Delete all saved orders?")) return;
        saveOrders([]);
        renderAdminOrders();
      });

      clearStorageBtn.addEventListener("click", () => {
        if (
          !confirm(
            "This will clear products and orders from localStorage. Continue?"
          )
        )
          return;
        localStorage.removeItem(PRODUCTS_KEY);
        localStorage.removeItem(ORDERS_KEY);
        location.reload();
      });

      /* ===== Utilities ===== */
      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // show admin orders initially when modal opens
      renderAdminOrders();
    </script>
  </body>
</html>
